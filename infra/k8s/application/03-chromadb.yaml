# 1. Deployment: 실제 ChromaDB 컨테이너(Pod)를 실행하고 관리합니다.
apiVersion: apps/v1
kind: Deployment
metadata:
  name: chromadb
  namespace: trend-mirror # 앞서 정의한 namespace로 사용합니다.
spec:
  replicas: 1 # Vector DB는 동시 쓰기 문제로 보통 1개만 띄웁니다.
  selector:
    matchLabels:
      app: chromadb
  template:
    metadata:
      labels:
        app: chromadb
    spec:
      containers:
      - name: chromadb
        image: chromadb/chroma:latest
        ports:
        - containerPort: 8800
        env:
        # 데이터 영구 저장을 위한 환경변수 설정
        - name: IS_PERSISTENT
          value: "TRUE"
        - name: PERSIST_DIRECTORY
          value: "/data"
        # 최신 버전 호환성을 위한 경로 설정
        - name: CHROMA_PERSIST_DIRECTORY
          value: "/data"
        - name: CHROMA_SERVER_AUTH_PROVIDER
          value: ""
        volumeMounts:
        - name: chromadb-data
          mountPath: /data # 컨테이너 내부의 /data 경로를 저장소와 연결
      volumes:
      - name: chromadb-data
        persistentVolumeClaim:
          claimName: chromadb-pvc # 아래에서 정의할 PVC를 사용
---
# 2. Service: 백엔드가 'chromadb'라는 이름으로 DB를 찾을 수 있게 해줍니다.
apiVersion: v1
kind: Service
metadata:
  name: chromadb
  namespace: trend-mirror # 앞서 정의한 namespace로 사용합니다.
spec:
  selector:
    app: chromadb
  ports:
  - port: 8800
    targetPort: 8800
    protocol: TCP
  type: ClusterIP # 클러스터 내부에서만 접근 가능 (보안)
---
# 3. PersistentVolumeClaim (PVC): 데이터를 저장할 실제 디스크 공간을 요청합니다.
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: chromadb-pvc
  namespace: medical-qa # 앞서 정의한 namespace로 사용합니다.
spec:
  accessModes:
  - ReadWriteOnce # 하나의 노드에서만 쓰기 가능
  resources:
    requests:
      storage: 5Gi # 5GB 용량 할당
  storageClassName: local-path # (환경에 따라 gp2, standard 등으로 변경 필요)